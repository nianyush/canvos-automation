name: CanvOS Build

on:
  workflow_dispatch:
    inputs:
      canvos_tag:
        type: choice
        description: Choose the CanvOS Tag
        options:
          - v4.0.6
          - main
        default: v4.0.6
      custom_image_tag:
        type: string
        description: Custom Image Tag
        default: edge
      image_registry:
        type: string
        description: Image Registry
        default: gcr.io/spectro-dev-public
      image_repo:
        type: string
        description: Image Repo
        default: edge-native
      os_distribution:
        type: choice
        description: Choose the OS distribution
        options:
          - ubuntu+20
          - ubuntu+22
          - opensuse-leap+15.4
        default: ubuntu+22
      k8s_distribution:
        type: choice
        description: Choose the K8S distribution
        options:
          - kubeadm
          - kubeadm-fips
          - k3s
          - rke2
        default: kubeadm
      iso_name:
        type: string
        description: ISO Name
        default: palette-edge-installer
      arch:
        type: choice
        description: Architecture
        options:
          - amd64
          - arm64
        default: amd64
      base_image:
        type: string
        description: Base Image
      build_type:
        type: choice
        description: Build Type
        options:
          - ISO-Provider
          - Provider
        default: ISO-Provider
      output_artifact:
        type: choice
        description: Output Artifact Type
        options:
          - ISO
          - VMDK
          - OVA
          - RAW
        default: ISO
      upload_iso_to_s3:
        type: choice
        description: Upload ISO to S3
        options:
          - Yes
          - No
        default: No

jobs:
  canvos:
    runs-on: "canvos-build"
    timeout-minutes: 240
    environment: "US_DC"
    steps:
      - uses: actions/checkout@v3
      - name: Run tests
        uses: ./.github/actions/canvos
        with:
          environment: "US_DC"
          canvos_tag: ${{ inputs.canvos_tag }}
          custom_image_tag: ${{ inputs.custom_image_tag }}
          image_registry: ${{ inputs.image_registry }}
          image_repo: ${{ inputs.image_repo }}
          os_distribution: ${{ inputs.os_distribution }}
          k8s_distribution: ${{ inputs.k8s_distribution }}
          iso_name: ${{ inputs.iso_name }}
          arch: ${{ inputs.arch }}
          base_image: ${{ inputs.base_image }}
          build_type: ${{ inputs.build_type }}
          output_artifact: ${{ inputs.output_artifact }}
          upload_iso_to_s3: ${{ inputs.upload_iso_to_s3 }}
          GCP_SPECTRO_DEV_PUBLIC_BASE64_ENCODED_JSON: ${{ secrets.GCP_SPECTRO_DEV_PUBLIC_BASE64_ENCODED_JSON }}
          VSPHERE_URL: ${{ secrets.VSPHERE_URL }}
          VSPHERE_USERNAME: ${{ secrets.VSPHERE_USERNAME }}
          VSPHERE_PASSWORD: ${{ secrets.VSPHERE_PASSWORD }}
          VSPHERE_FOLDER: ${{ secrets.VSPHERE_FOLDER }}
          VSPHERE_DATACENTER: ${{ secrets.VSPHERE_DATACENTER }}
          VSPHERE_DATASTORE: ${{ secrets.VSPHERE_DATASTORE }}
          VSPHERE_NETWORK: ${{ secrets.VSPHERE_NETWORK }}
          VSPHERE_HOST: ${{ secrets.VSPHERE_HOST }}
          VSPHERE_CLUSTER: ${{ secrets.VSPHERE_CLUSTER }}
          
            
            
